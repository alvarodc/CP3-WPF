<UserControl x:Class="CardPass3.WPF.Modules.Readers.Views.ReadersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:CardPass3.WPF.Core.Converters">

    <UserControl.Resources>
        <conv:ReaderStateToLabelConverter   x:Key="StateLabel"/>
        <conv:ReaderStateToBrushConverter   x:Key="StateBrush"/>
        <conv:BoolToVisibilityConverter     x:Key="BoolToVis"/>
        <conv:InverseBoolToVisibilityConverter x:Key="InvBoolToVis"/>
        <conv:StringNotEmptyToVisibilityConverter x:Key="StringToVis"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Header + toolbar -->
            <RowDefinition Height="*"/>     <!-- Grid -->
            <RowDefinition Height="Auto"/>  <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- ── HEADER + TOOLBAR ──────────────────────────────────── -->
        <DockPanel Grid.Row="0" Margin="0,0,0,16">

            <!-- Título y contador -->
            <StackPanel DockPanel.Dock="Left" VerticalAlignment="Center">
                <TextBlock Text="Lectores"
                           FontFamily="Segoe UI Light" FontSize="22"
                           Foreground="{StaticResource TextPrimaryBrush}"/>
                <TextBlock FontFamily="Segoe UI" FontSize="12"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           Margin="0,2,0,0">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0} conectados de {1}">
                            <Binding Path="ConnectedCount" Mode="OneWay"/>
                            <Binding Path="TotalCount" Mode="OneWay"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </StackPanel>

            <!-- Toolbar derecha -->
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">

                <!-- CRUD -->
                <Button Content="&#xE710; Nuevo"
                        Style="{StaticResource Btn.Primary}"
                        Command="{Binding AddReaderCommand}"
                        Padding="14,0" Margin="0,0,6,0"/>
                <Button Content="&#xE70F; Editar"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding EditReaderCommand}"
                        Padding="14,0" Margin="0,0,6,0"/>
                <Button Content="&#xE74D; Eliminar"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding DeleteReaderCommand}"
                        Padding="14,0" Margin="0,0,16,0"
                        Foreground="#C62828"/>

                <!-- Separador visual -->
                <Border Width="1" Height="20" Background="{StaticResource BorderBrush}" Margin="0,0,16,0"/>

                <!-- Conexión -->
                <Button Content="Conectar"
                        Style="{StaticResource Btn.Primary}"
                        Command="{Binding ConnectReaderCommand}"
                        Margin="0,0,6,0"/>
                <Button Content="Desconectar"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding DisconnectReaderCommand}"
                        Margin="0,0,16,0"/>

                <!-- Separador visual -->
                <Border Width="1" Height="20" Background="{StaticResource BorderBrush}" Margin="0,0,16,0"/>

                <!-- Habilitar/deshabilitar -->
                <Button Content="Habilitar"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding EnableReaderCommand}"
                        Margin="0,0,6,0"/>
                <Button Content="Deshabilitar"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding DisableReaderCommand}"
                        Margin="0,0,16,0"/>

                <!-- Separador visual -->
                <Border Width="1" Height="20" Background="{StaticResource BorderBrush}" Margin="0,0,16,0"/>

                <!-- Comandos al hardware -->
                <Button Content="Abrir relé"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding OpenRelayCommand}"
                        Margin="0,0,6,0"/>
                <Button Content="&#xE72C; Reiniciar"
                        Style="{StaticResource Btn.Ghost}"
                        Command="{Binding RestartReaderCommand}"/>
            </StackPanel>
        </DockPanel>

        <!-- ── GRID DE LECTORES ───────────────────────────────────── -->
        <Border Grid.Row="1" Style="{StaticResource Card}" Padding="0">
            <DataGrid Style="{StaticResource Grid.Base}"
                      ItemsSource="{Binding Readers}"
                      SelectedItem="{Binding SelectedReader}"
                      RowHeight="44">
                <DataGrid.Columns>

                    <!-- Estado -->
                    <DataGridTemplateColumn Header="Estado" Width="130" SortMemberPath="State">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource Badge.State}"
                                        Background="{Binding State, Converter={StaticResource StateBrush}}">
                                    <TextBlock Text="{Binding State, Converter={StaticResource StateLabel}}"
                                               FontFamily="Segoe UI Semibold" FontSize="11"
                                               Foreground="White"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Habilitado -->
                    <DataGridTemplateColumn Header="Act." Width="44" SortMemberPath="Reader.Enabled">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Ellipse Width="8" Height="8" HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Setter Property="Fill" Value="#43A047"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Reader.Enabled}" Value="False">
                                                    <Setter Property="Fill" Value="#BDBDBD"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Descripción -->
                    <DataGridTextColumn Header="Descripción"
                                        Binding="{Binding Reader.ReaderDescription}"
                                        Width="*">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontFamily" Value="Segoe UI Semibold"/>
                                <Setter Property="FontSize" Value="12"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- IP efectiva -->
                    <DataGridTextColumn Header="Dirección IP"
                                        Binding="{Binding Reader.EffectiveIp}"
                                        Width="150">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontFamily" Value="Consolas"/>
                                <Setter Property="FontSize" Value="12"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Foreground" Value="#546E7A"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Puerto -->
                    <DataGridTextColumn Header="Puerto"
                                        Binding="{Binding Reader.Port}"
                                        Width="70">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontFamily" Value="Consolas"/>
                                <Setter Property="FontSize" Value="12"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Foreground" Value="#546E7A"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Tipo -->
                    <DataGridTemplateColumn Header="Tipo" Width="80" SortMemberPath="Reader.ControlType">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock FontFamily="Segoe UI" FontSize="11"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource TextSecondaryBrush}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="Salida"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Reader.ControlType}" Value="0">
                                                    <Setter Property="Text" Value="Entrada"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Último intento -->
                    <DataGridTemplateColumn Header="Último intento" Width="120" SortMemberPath="LastAttemptAt">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock FontFamily="Segoe UI" FontSize="11"
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           VerticalAlignment="Center"
                                           Text="{Binding LastAttemptAt, StringFormat={}{0:HH:mm:ss}, TargetNullValue=—}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Detalle de error -->
                    <DataGridTemplateColumn Header="Detalle" Width="180">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ErrorMessage, TargetNullValue='—'}"
                                           FontFamily="Segoe UI" FontSize="11"
                                           Foreground="#EF5350"
                                           VerticalAlignment="Center"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTip="{Binding ErrorMessage}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- ── STATUS BAR ────────────────────────────────────────── -->
        <Border Grid.Row="2"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="6"
                Padding="16,10"
                Margin="0,10,0,0"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="&#xE117;" FontFamily="Segoe MDL2 Assets" FontSize="13"
                           Foreground="{StaticResource AccentBrush}" VerticalAlignment="Center"/>
                <TextBlock Text="Operación en curso…" FontFamily="Segoe UI" FontSize="12"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           Margin="8,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

    </Grid>
</UserControl>
